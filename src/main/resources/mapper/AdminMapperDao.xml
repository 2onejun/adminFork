<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">



<mapper namespace="com.example.admin.dao.AdminMapper">

    <select id="selectHospListAll" resultType="com.example.admin.dto.HospitalDTO">
        select
            hosp_id as hospId,
            cl_cd   as clCd,
            addr,
            cl_cd_nm as clCdNm,
            emdong_nm as emdongNm,
            estb_dd as estbDd,
            hosp_url as hospUrl,
            post_no as postNo,
            sggu_cd as sgguCd,
            sggu_cd_nm as sgguCdNm,
            sido_cd as sidoCd,
            sido_cd_nm as sidoCdNm,
            telno,
            yadm_nm as yadmNm,
            ykiho,
            hosp_status as hospStatus
        from HOSPITAl
    </select>
<!-- 유저 검색 -->
    <select id="selectUserListAll" parameterType="map" resultType="com.example.admin.dto.UserDTO">
        select
            user_id  as userId,
            IFNULL(provider_id, '')   as  providerId,
            email  as  email,
            username  as  username,
            phone,
            CONCAT(
            substring(phone, 1, 3),
            '-',
            substring(phone, 4, 4),
            '-',
            substring(phone, 8, 4)
            ) as   phoneStr,
            role   as  role,
            IFNULL(provider, '')  as  provider,
            CONCAT(
            zipcode,
            '-',
            address_line1,
            '-',
            address_line2,
            '-',
            city,
            '-',
            state) as addressStr,
            status,
            CASE  status
            WHEN 'ACTIVE' THEN '활동'
            WHEN 'DEACTIVATED' THEN '비활동'
            ELSE ''
            END AS statusStr,
            zipcode as   zipcode,
            address_line1  as  addressLine1,
            address_line2  as  addressLine2,
            city  as  city,
            state  as  state,
            IFNULL(DATE_FORMAT(created_at, '%Y-%m-%d'),'') as createdAtStr,
            created_by  as  createdBy,
            IFNULL(DATE_FORMAT(modified_at, '%Y-%m-%d'),'') as modifiedAtStr,
            modified_by  as  modifiedBy
        from USER
        <!--   where 1=1은 반드시 실행 되게  -->
        where 1=1

        <if test="username != null and  username !='' ">
            and username like '%${username}%'
        </if>

        <if test="phone != null and  phone !='' ">
            and phone like '%${phone}%'
        </if>

        <if test="email != null and  email !='' ">
            and email like '%${email}%'
        </if>

        <if test="user_id != null and  user_id !='' ">
            and user_id  = ${userId}
        </if>

    </select>

    <!-- 유저 검색 -->
    <select id="getUserInfo" parameterType="_long" resultType="com.example.admin.dto.UserDTO">
        select
        user_id  as userId,
        email  ,
        username  ,
        phone,
        CONCAT(
        substring(phone, 1, 3),
        '-',
        substring(phone, 4, 4),
        '-',
        substring(phone, 8, 4)
        ) as   phoneStr,
        role ,
        IFNULL(provider, '')  as  provider,
        CONCAT(
        zipcode,
        '-',
        address_line1,
        '-',
        address_line2,
        '-',
        city,
        '-',
        state) as addressStr,
        status,
        CASE  status
        WHEN 'ACTIVE' THEN '활동'
        WHEN 'DEACTIVATED' THEN '비활동'
        ELSE ''
        END AS statusStr,
        IFNULL(DATE_FORMAT(created_at, '%Y-%m-%d'),'') as createdAtStr,
        IFNULL(DATE_FORMAT(modified_at, '%Y-%m-%d'),'') as modifiedAtStr
        from USER

        where
        user_id  = ${paramId}
    </select>


    <!-- 유저 검색Rest -->
    <select id="getUserInfoRest" parameterType="map" resultType="com.example.admin.dto.UserDTO">
        select
        user_id  as userId,
        email  ,
        username  ,
        CONCAT(
        substring(phone, 1, 3),
        '-',
        substring(phone, 4, 4),
        '-',
        substring(phone, 8, 4)
        ) as   phoneStr,
        role ,
        IFNULL(provider, '')  as  provider,
        CONCAT(
        zipcode,
        '-',
        address_line1,
        '-',
        address_line2,
        '-',
        city,
        '-',
        state) as addressStr,
        status,
        CASE  status
        WHEN 'ACTIVE' THEN '활동'
        WHEN 'DEACTIVATED' THEN '비활동'
        ELSE ''
        END AS statusStr,
        IFNULL(DATE_FORMAT(created_at, '%Y-%m-%d'),'') as createdAtStr,
        IFNULL(DATE_FORMAT(modified_at, '%Y-%m-%d'),'') as modifiedAtStr
        from USER

        where
        user_id  = ${paramId}
    </select>


<!--병원 예약-->
    <select id="selectHospitalReservationListAll" resultType="com.example.admin.dto.HospitalReservationDTO">

        select
        hosp_reservation_id as hospReservationId,   --  예약 번호
        h.yadm_nm as '병원이름',  -- 병원 이름
        u.user_id ,     --  회원 ID
        u.username as "회원 이름",   -- 회원 이름
        IFNULL(DATE_FORMAT(reservation_at, '%Y-%m-%d'),'')  as reservationAt,    -- 예약 날짜
        reservation_time   as reservationTime,  -- 예약 시간
        CASE  reservation_status
        WHEN 'SUCCESS' THEN '예약'
        WHEN 'CANCELLED' THEN '취소'
        ELSE ''
        END AS reservationStatus -- 예약 상태

        from
        hospital_reservation hr
        inner join  USER u
        on hr.user_id=u.user_id
        inner join HOSPITAl h
        on hr.hosp_id=h.hosp_id
        WHERE  1=1
        order by reservation_at desc ,reservation_time desc;

    </select>

<!--  회원 정보 수정   -->
    <update id="userUpdate"
            parameterType="com.example.admin.dto.HospitalReservationDTO">
        UPDATE User
        SET
            username = #{username},
            phone = #{phone},
            status = #{status},
            modified_at = now()
        WHERE user_id  = ${userId}
    </update>
</mapper>

